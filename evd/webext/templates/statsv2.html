{% extends "base.html" %}{% load tags %} 
{% block head_styles %} {{ block.super }}
<link rel="stylesheet" href="/static/css/stats.css" />

<style>
.right-content .top {
	padding: 34px 37px;
}

.subcontent {
	background: none;
}

div.intro h3 {
	padding-bottom: 35px;
}
.selectOption{
	width: 180px;
}
div.video {
	padding: 50px;
}

input {
	display: inline-block;
}

label {
	position: relative;
}
.google-visualization-table-td {
text-align: center;
}
.google-visualization-table-th {
text-align: center;
}
.google-visualization-table-td.google-visualization-table-type-number {
text-align: center;
white-space: nowrap;
}
</style>
{% endblock %} {% block head_scripts %}
{{ block.super }}
<script src="https://www.gstatic.com/charts/loader.js"></script>

<script>
	$(document).ready(function() {
		$(function() {
			$('#from').datepicker({
				changeMonth : true,
				minDate : new Date(2013, 3, 1),
				dateFormat : "dd-mm-yy"
			});
			$('#to').datepicker({
				changeMonth : true,
				minDate : new Date(2013, 3, 8),
				dateFormat : "dd-mm-yy"
			});
			var query = window.location.search.substring(1);
			if (query != "") {
				var query_list = query.split("&");
				for ( var qry in query_list) {
					if (query_list[qry].indexOf("from=") != -1) {
						frm = query_list[qry].substring(5);
					} else if (query_list[qry].indexOf("to=") != -1) {
						t = query_list[qry].substring(3);
					}
				}
				$('#from').val(frm);
				$('#to').val(t);
			} else {
				var today = new Date();
				var tomorrow = new Date();
				tomorrow = new Date(tomorrow.setDate(today.getDate() + 1));
				$('#from').val(today.getDate() + "-" + (today.getMonth() + 1) + "-" + today.getFullYear());
				$('#to').val(tomorrow.getDate() + "-" + (tomorrow.getMonth() + 1) + "-" + tomorrow.getFullYear());
			}
		});
		$("#my_div").click(function() {
			$('#toog1').fadeOut();
			$('#det').fadeOut();
			$('#toog2').fadeIn("slow");
		});
		$("#sess").click(function() {
			$('#toog2').fadeOut();
			$('#det').fadeOut();
			$('#toog1').slideDown("slow");
		});
		$("#sess1").click(function() {
			$('#toog2').fadeOut();
			$('#det').fadeOut();
			$('#toog1').slideDown("slow");
		});
		$("#extend").click(function() {
			$('#toog2').fadeOut();
			$('#toog1').fadeOut();
			$('#det').fadeIn();
		});
		$("button").click(function() {
			$(this).toggleClass("active").next().slideToggle("fast");
			if ($.trim($(this).find("span").text()) === 'Show ▼') {
				$(this).find("span").text('Hide ▲');
			} else {
				$(this).find("span").text('Show ▼');
		}
		return false;
		});
	});
</script>
{% endblock %}
{% block doc_ready %}
google.charts.load('current', {packages:['table', 'controls',"corechart",'bar',"LineChart"], callback: drawTable});
function drawTable() {
	var centerId = {{center_id}};
	if(centerId == -1){
		$('.grstats').hide();
        $('.barstats').hide();
        $('#toog2').hide();
        $('#toog1').hide();
        $('#course_btn').hide();
        $('button').hide();
        $('.grstats').hide();
    }else{$('#toog1').slideUp();
        $('#sess1').slideUp();
    }
    var data = new google.visualization.DataTable();
    if( centerId ==  -1) {
        $('#global_div').append('<center><table style="width:100%;padding:10px 10px 10px 10px;text-align:center;color:white;"><tr>'+
        '<td>&nbsp&nbsp&nbsp</td><td><span style="color: white;" id="centerCountId"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span style="color: white;" class="teacherCount"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span style="color: white;" class="active_teacherCount"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span class="active_offering_Count"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span class="childrenCount"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span class="planVsActual"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '<td><span class="totalAttendance"><img src="/static/img_new/color_ajax_loader.gif" width="15"/></span></td>'+
        '</tr>'+
        '<tr><td></td><td>Centers </td><td style="color: white;">Teachers</td><td>Active Teachers</td><td>Active Offering</td><td>Total Children </td><td>Classes-Plan vs Actual </td>'+
        '<td>Attendance </td></tr></table></center>');
     }else{
        data.addColumn('string','Subject') ;
        data.addColumn('string','Grade') ;
        data.addColumn('string','Teacher') ;
        data.addColumn('string','Active Teacher') ;
        data.addColumn('string','Active Offering') ;
        data.addColumn('number','Planned Sessions') ;
        data.addColumn('number','Actual Sessions') ;
        data.addColumn('number','Total Children') ;
        data.addColumn('number','Attendance Percentage') ;
        $('#global_div').append('<center><table style="width:100%;padding:10px 10px 10px 10px;text-align:center;color:white;"><tr>'+
        '<td><span style="color: white;" class="teacherCount"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '<td><span class="active_teacherCount"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '<td><span class="active_offering_Count"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '<td><span class="planVsActual"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '<td><span class="childrenCount"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '<td><span class="totalAttendance"><img src="/static/img_new/color_ajax_loader.gif" width="20"/></span></td>'+
        '</tr><tr><td style="color:white;">Teachers</td><td>Active Teachers</td><td>Active Offering</td><td>Classes-plan vs actual</td><td>Children</td><td>Attendance</td></tr></table></center>');

     }
}
{% endblock %}
{% block body_container %}
{%if is_partner or is_school_admin %}
<div class="inner">
	<div class="col-md-2" style="height: 100%;">
	  {%include "navbar.html"%}
	</div>
	<div class="col-md-10" style="height: 100%; overflow-y: auto; right: -15px; padding-left: 3%;">
{%else%}
<div class="admin_inner">
     <div class="col-md-12">
{%endif%}
<div class="title">
<input type="hidden" value="{{msg}}" id="noCenter">
	<h1 style="color: white;">
		Operations Dashboard : <span class="strokeme"
			style="color:white;">{{centername}}
			</span>
	</h1>
</div>
<form name="input" method='get' style="width:100%;">
	<div style='margin-top: 20px;'>
		<div class="col-md-12 col-lg-12 col-sm-12 col-xs-12">
			<div class="col-md-3 col-sm-3 col-lg-3 col-xs-3" style="float: left;text-align:center;">
				State
				<select id='state_id' name='state_id' class="selectOption">
					<option value='-1'>All</option>
					{% for state in all_states %}
						<option value='{{state}}'
						{% if state == state_name %}
							selected="selected"
						{% endif %}
						>{{state}}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-4 col-sm-4 col-lg-4 col-xs-4" style="float: left;text-align:center;">
				Partner
				<select id='id_partner' name='partner_id' class="selectOption">
					<option value=-1>All</option>
				</select>
			</div>
			<div class="col-md-5 col-sm-5 col-lg-5 col-xs-5" style="float: left;text-align:center;">
			Donor: <select id='id_fund_partner' name='funding_partner_id' style="width: 389px;">
				<option value=-1>All</option>
			</select>
			</div>
			</div>
			<!-- <div class="col-md-12 col-sm-12 col-lg-12 col-xs-12" style="float: left;text-align:center;"><br/></div> -->
			<div class="col-md-12 col-sm-12 col-lg-12 col-xs-12" style="margin-top: 49px;">
			<div class="col-md-3 col-sm-3 col-lg-3 col-xs-3" style="float: left;text-align:center;">
				Center
				<select style ="margin-top: -3%; height:65px" id='center_id' name='center_id' class="selectOption" multiple>
					<option value=-1>All</option>
				</select>
			</div>
			<div class="col-md-4 col-sm-4 col-lg-4 col-xs-4" style="float: left;text-align:center ;">
					From &nbsp;<input type="text" style='width: 187px; padding-left:20px;' id="from" name='from' required>
			</div>
			<div class="col-md-5 col-sm-5 col-lg-5 col-xs-5" style="float: left;text-align:center;    margin-left: -103px;			">
					To <input type="text" id="to" style='width: 187px;padding-left:20px;position:relative;left:16px;' name='to' required>
			</div>
			
		</div>
		<div class="col-md-12" style='margin-top: 23px;'>
			<div class="col-md-3 col-sm-3 col-lg-3 col-xs-3" style="float: left;text-align:center;">
				Academic Year
				<select  id="ay_id" name='ay_id' style="width:122px;">
				{% for ayfys_title in ayfys_titles %}
				<option value="{{ayfys_title}}"
					{% if ayfys_title == ay_id %}
						selected="selected"
					{% endif %}
				>{{ayfys_title}}</option>
				{% endfor %}
				</select>
			</div>
			<div class="col-md-4 col-sm-4 col-lg-4 col-xs-4" style="float: left;text-align:center;">
			
				<label for="cars">Choose timings:</label>

<select name="from_time" id="fromtime" value='{{time_start}}'>
	<option value={{time_start}}>{{time_start}}</option>
  <option value="7:00">7:00</option>
  <option value="8:00">8:00</option>
  <option value="9:00">9:00</option>
  <option value="10:00">10:00</option>
  <option value="11:00">11:00</option>
  <option value="12:00">12:00</option>
  <option value="13:00">13:00</option>
  <option value="14:00">14:00</option>
  <option value="15:00">15:00</option>
  <option value="16:00">16:00</option>
  <option value="17:00">17:00</option>
  <option value="18:00">18:00</option>
  <option value="19:00">19:00</option>
  <option value="20:00">20:00</option>
  <option value="21:00">21:00</option>
  
</select>
<select name="to_time" id="totime" value ='{{time_end}}'>
	<option value={{time_end}}>{{time_end}}</option>
	<option value="8:00">8:00</option>
	<option value="9:00">9:00</option>
	<option value="10:00">10:00</option>
	<option value="11:00">11:00</option>
	<option value="12:00">12:00</option>
	<option value="13:00">13:00</option>
	<option value="14:00">14:00</option>
	<option value="15:00">15:00</option>
	<option value="16:00">16:00</option>
	<option value="17:00">17:00</option>
	<option value="18:00">18:00</option>
	<option value="19:00">19:00</option>
	<option value="20:00">20:00</option>
	<option value="21:00">21:00</option>
  </select>
</div>
<div class="col-md-5 col-sm-5 col-lg-5 col-xs-5" style="float: left;text-align:center;">
			
				<input type='submit' value='Submit' class='btn btn-success' style='display: inline-block; width: 40%;     margin-right: 137px;'>
</div>
			
	</div>
   </div>
</form>
<div class="stats" id="extend" style="width:100%;">
	<!-- <div class="head_box"> -->
		<p style="color: white;">Summary</p>
	<!-- </div> -->
	<div class="stats-body" id="global_div">
	</div>
</div>
<div style="display:inline-block;width:100%;">
	<div class="stats" id="sess" style="width: 49%; cursor: pointer;float:left;">
		<div class="head_box">
			<p style="color: white;">Classes</p>
		</div>
		<div class="stats-body">
			<div id='pie_div' style="height: 260px">
				<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:100px;margin-left:220px;width:50px" />
			</div>
		</div>
	</div>
	<div class="stats" id="sess" style="width: 49%; cursor: pointer;float:right;margin-right: 0px;">
		<div class="head_box">
			<p style="color: white;">Cancelled Classes</p>
		</div>
		<div class="stats-body">
			<div id='reasons_pie_div' style="height: 260px">
				<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:90px;margin-left:200px;width:50px" />
			</div>
		</div>
	</div>

	<!-- <div class="stats" style="width: 452px;">
		<div class="head_box">
			<p>Children Attendance</p>
		</div>
		<div class="stats-body">
			<div id='my_div' style="height: 260px; top: 100%;">
				<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:100px;margin-left:220px;width:50px" />
			</div>
		</div>
	</div> -->
</div>

<button
	style="width: 100%; background-color: #27a3e2; color: white; height: 40px; margin-top: 10px; position: left; border: none;">
	<h1 style="padding-top: 80px; font-size: 15px; display: inline;">Course
		coverage</h1>
	<span style="float: right">Hide ▲</span>
</button>
<div class="grstats"
	style="width: 100%; overflow-y:scroll;margin-top: 0px; margin-bottom: 10px; margin-left: 1px;">
	<div class="stats-body" style="height: 300px; width: 1070px;" id="show">
		{% if request.user.is_superuser%}
		<div id='gr_div'
			style="height: 300px; width: 1200px; top: 0%; position: relative">
		{% else %}
		<div id='gr_div'
		style="height: 300px; width: 1400px; top: 0%; position: relative">
		{% endif %}
			<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:100px;margin-left:430px;width:50px" />
			</div>
	</div>
</div>
<div class="stats" id="det" style="width: 100%;">
	<div class="head_box">
		<p style="color: white;">Details</p>
	</div>
	<div class="stats-body" style="top: 0%; margin-top: 34px;">
		<div id='table_div'>
			<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:100px;margin-left:430px;width:50px" />
		</div>
	</div>
</div>
<div class="stats" id="toog1" style="width: 100%;height: 650px; overflow: auto;">
	<div class="head_box">
		<p>Classes Details</p>
	</div>
	<div class="stats-body" style="top: 0%; margin-top: 34px;">
		<div id="sess_dash_div" style="">
			<div style="margin-top: 20px;">
				<div class="row">
					<div class='col-md-4 filtercust' id="sess_coursefilter_div"
						style="padding-left: 30px;padding-bottom: 10px;"></div>
					<div class='col-md-4' id="sess_status_div" style="padding-left: 30px;padding-bottom: 10px;"></div>
					<div class='col-md-4' id="teacher_div" style="padding-left: 30px;padding-bottom: 10px;"></div>
				</div>
				<div class="row">
					<div class='col-md-4' id="center_div" style="padding-left: 30px;padding-bottom: 10px;"></div>
					<div class='col-md-5' id="cancel_reason_id" style="padding-left: 30px;padding-bottom: 10px;"></div>
				</div>
			</div>
			<div id="sess_table_div" style="width: 100%; height: 470px; overflow: scroll;">
				<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:10px;margin-left:430px;width:50px" />
			</div>

		</div>
	</div>
</div>
<div class="stats" id='toog2' style="width: 100%; display: none">
	<div class="head_box">
		<p>Attendance Details</p>
	</div>
	<div class="stats-body" style="top: 0%; margin-top: 34px;">
		<div id="attnd_dash_div">
			<div style="margin-top: 20px;">
				<div id="coursefilter_div" style="display: inline-block;"></div>
				<div id="Session_status_div" style="display: inline-block;"></div>
			</div>
			<div id="attnd_table_div"style="width: 100%;height: 300px;overflow: scroll;">
				<img src="/static/img_new/color_ajax_loader.gif" style="margin-top:10px;margin-left:430px;width:50px" />
			</div>
		</div>
	</div>
</div>
 <div id="evd-notification" class="no_Center alert alert-warning hide" style="">
                            <div>
                                <a type="button" class="close redirectTomyevidyaloka">X</a>
                                <p class="msg-body messageBox"></p>
                            </div>
                        </div>
	</div>
</div>
</div>
<script>

function fetchCentersByState(funding_partner_id = -1){
	var state = $("#state_id").val();
	var id_partner = -1;
	var ay_id = $('#ay_id').val();
	$("#center_id").empty();
	$("#id_partner").empty();
	$.ajax({
		url : '/v2/ajax/getCentesByState?state=' + state+'&partner='+id_partner+'&ay_id='+ay_id+'&id_fund_partner='+funding_partner_id,
		dataType : 'JSON',
		success : function(data){
			var pid_html = "{{partner_id}}";
			if (data!=null && data!='' && data!='undefined'){
				if (pid_html == -1){
					var options = '<option value=-1>All</option>';
					for (i=0;i<data.length;i++){
						if (data[i]['name'] != "undefined"){
						options += '<option value="'+data[i]['id']+'"';
						if (data[i]['id']=='{{center_id}}')
							options += 'selected="selected" ';
						options += '>'+data[i]['name']+'</option>';
					}
					}
					$("#center_id").append(options);
				
				}
				else {
					var onload_state = $("#state_id").val();
					var ay_id=$('#ay_id').val();
					$("#center_id").empty();
					$.ajax({
						url : '/v2/ajax/getCentesByState?state=' + onload_state+'&partner='+pid_html+'&ay_id='+ay_id,
						dataType : 'JSON',
						success : function(data){
							if (data!=null && data!='' && data!='undefined'){
								var options = '<option value=-1>All</option>';
								for (i=0;i<data.length;i++){
									if (data[i]['name'] != "undefined"){

									options += '<option value="'+data[i]['id']+'"';
									if (data[i]['id']=='{{center_id}}')
										options += 'selected="selected" ';
									options += '>'+data[i]['name']+'</option>';
								}
								}
								$("#center_id").append(options);
							}

						}
					});
				}

				var partner_list = []
				for (i=0;i<data.length;i++){
					var is_present = 'no';
					for(j=0;j<partner_list.length;j++){
						if(data[i]['partnerid'] == partner_list[j]['partnerid']){

							is_present = 'yes';
							break;
						}
					}
					if((is_present == 'no') && (data[i]['partnerid'] != 'undefined')){
						partner_list.push({'partnerid':data[i]['partnerid'],'partner_name':data[i]['partner_name']});
					}
				}

				var options = '<option value=-1>All</option>';
				for (i=0;i<partner_list.length;i++){
					options += '<option value="'+partner_list[i]['partnerid']+'"';
					if (partner_list[i]['partnerid']=='{{partner_id}}')
						options += 'selected="selected" ';
					options += '>'+partner_list[i]['partner_name']+'</option>';
				}
				$("#id_partner").empty();
				$("#id_partner").append(options);
			}
			if ($("#id_fund_partner").val()==-1 || $("#id_fund_partner").val()=='All' )
			{
			var funding_partner_list = []
				for (i=0;i<data.length;i++){
					var is_present = 'no';
					for(j=0;j<funding_partner_list.length;j++){
						if(data[i]['fundingpartner_id'] == funding_partner_list[j]['fundingpartner_id']){

							is_present = 'yes';
							break;
						}
					}
					if(is_present == 'no'){
						if (data[i]['fundingpartner_id'] != null){
							funding_partner_list.push({'fundingpartner_id':data[i]['fundingpartner_id'],'fundingpartner_name':data[i]['fundingpartner_name']});
						}
					}
				}

				var options = '<option value=-1>All</option>';
				for (i=0;i<funding_partner_list.length;i++){
					options += '<option value="'+funding_partner_list[i]['fundingpartner_id']+'"';
					if (funding_partner_list[i]['fundingpartner_id']=='{{funding_partnerid}}')
						options += 'selected="selected" ';
					options += '>'+funding_partner_list[i]['fundingpartner_name']+'</option>';
				}

				$("#id_fund_partner").empty();
				$("#id_fund_partner").append(options);
		}

			}
	});

}

$("#state_id").on('change',function(){
	fetchCentersByState();
});

$("#id_partner").on('change',function(){
	var state = $("#state_id").val();
	var id_partner = $("#id_partner").val();
	var ay_id=$('#ay_id').val();
	$("#center_id").empty();
	var id_fund_partner= $("#id_fund_partner").val();
	// var id_fund_partner = -1;
	$.ajax({
		url : '/v2/ajax/getCentesByState?state=' + state+'&partner='+id_partner+'&ay_id='+ay_id+'&id_fund_partner='+id_fund_partner,
		dataType : 'JSON',
		success : function(data){
			if (data!=null && data!='' && data!='undefined'){
				var options = '<option value=-1>All</option>';
				for (i=0;i<data.length;i++){
					if (data[i]['name'] != "undefined"){

					options += '<option value="'+data[i]['id']+'"';
					if (data[i]['id']=='{{center_id}}')
						options += 'selected="selected" ';
					options += '>'+data[i]['name']+'</option>';
				}
				}
				$("#center_id").append(options);
			}
			if($("#id_fund_partner").val()==-1 || $("#id_fund_partner").val()=='All')
			{
			var funding_partner_list = []
				for (i=0;i<data.length;i++){
					var is_present = 'no';
					for(j=0;j<funding_partner_list.length;j++){
						if(data[i]['fundingpartner_id'] == funding_partner_list[j]['fundingpartner_id']){

							is_present = 'yes';
							break;
						}
					}
					if(is_present == 'no'){
						if (data[i]['fundingpartner_id'] != null){
							funding_partner_list.push({'fundingpartner_id':data[i]['fundingpartner_id'],'fundingpartner_name':data[i]['fundingpartner_name']});
						}
					}
				}

				var options = '<option value=-1>All</option>';
				for (i=0;i<funding_partner_list.length;i++){
					options += '<option value="'+funding_partner_list[i]['fundingpartner_id']+'"';
					if (funding_partner_list[i]['fundingpartner_id']=='{{funding_partnerid}}')
						options += 'selected="selected" ';
					options += '>'+funding_partner_list[i]['fundingpartner_name']+'</option>';

				}
				$("#id_fund_partner").empty();
				$("#id_fund_partner").append(options);
			}

		if ($("#state_id").val()==-1 || $("#state_id").val()=='All')
			{
				var state_list = []
                        for (i=0;i<data.length;i++){
                            var is_present = 'no';
                            for(j=0;j<state_list.length;j++){
                                if(data[i]['state'] == state_list[j]['state']){
                                    // <!--console.log(data[i]['state'])-->
                                    is_present = 'yes';
                                    break;
                                }
                            }
                            if(is_present == 'no'){
                                state_list.push({'state':data[i]['state']});
                            }
                        }

				var options = '<option value=-1>All</option>';
				for (i=0;i<state_list.length;i++){
					if (state_list[i]['state'] != 'undefined'){
					options += '<option value="'+state_list[i]['state']+'"';
					if (state_list[i]['state']=='{{state}}')
						options += 'selected="selected" ';
					options += '>'+state_list[i]['state']+'</option>';
					console.log(options)
				}
				}
				$("#state_id").empty();
				$("#state_id").append(options);

		}


		}
	});
});
$("#id_fund_partner").on('change',function(){
	var state = $("#state_id").val();
	var id_partner = $("#id_partner").val();
	var ay_id=$('#ay_id').val();
	var id_fund_partner=$("#id_fund_partner").val();
	console.log('fpp',id_fund_partner)
	$("#center_id").empty();
	$.ajax({
		url : '/v2/ajax/getCentesByState?state=' + state+'&partner='+id_partner+'&ay_id='+ay_id+'&id_fund_partner='+id_fund_partner,
		dataType : 'JSON',
		success : function(data){
			if (data!=null && data!='' && data!='undefined'){
				var options = '<option value=-1>All</option>';
				for (i=0;i<data.length;i++){
					if (data[i]['name'] != "undefined"){

					options += '<option value="'+data[i]['id']+'"';
					if (data[i]['id']=='{{center_id}}')
						options += 'selected="selected" ';
					options += '>'+data[i]['name']+'</option>';
				}
				}
				$("#center_id").append(options);
			}
			if ($("#id_partner").val()==-1 || $("#id_partner").val()=='All')
			{
			var partner_list = []
				for (i=0;i<data.length;i++){
					var is_present = 'no';
					for(j=0;j<partner_list.length;j++){
						if(data[i]['partnerid'] == partner_list[j]['partnerid']){

							is_present = 'yes';
							break;
						}
					}
				
					if((is_present == 'no') && (data[i]['partnerid'] != 'undefined')){
						partner_list.push({'partnerid':data[i]['partnerid'],'partner_name':data[i]['partner_name']});
					}
				}

				var options = '<option value=-1>All</option>';
				for (i=0;i<partner_list.length;i++){
					options += '<option value="'+partner_list[i]['partnerid']+'"';
					if (partner_list[i]['partnerid']=='{{partner_id}}')
						options += 'selected="selected" ';
					options += '>'+partner_list[i]['partner_name']+'</option>';
				}
				$("#id_partner").empty();

				$("#id_partner").append(options);
			}
			if ($("#state_id").val()==-1 || $("#state_id").val()=='All')
			{


			var state_list = []
                        for (i=0;i<data.length;i++){
                            var is_present = 'no';
                            for(j=0;j<state_list.length;j++){
                                if(data[i]['state'] == state_list[j]['state']){
                                    // <!--console.log(data[i]['state'])-->
                                    is_present = 'yes';
                                    break;
                                }
                            }
                            if(is_present == 'no'){
                                state_list.push({'state':data[i]['state']});
                            }
                        }

				var options = '<option value=-1>All</option>';
				for (i=0;i<state_list.length;i++){
					if (state_list[i]['state'] != 'undefined'){
					options += '<option value="'+state_list[i]['state']+'"';
					if (state_list[i]['state']=='{{state}}')
						options += 'selected="selected" ';
					options += '>'+state_list[i]['state']+'</option>';
				}
				}
				$("#state_id").empty();
				$("#state_id").append(options);

		}


		}
	});
});

function getDashboardSummeryData(params){
	$.ajax({
		url : '/v2/ajax/getSummaryData?' + params,
		dataType : 'JSON',
		success : function(data){
			$(".teacherCount").empty();
			$(".active_teacherCount").empty();
			$(".active_offering_Count").empty();
			$(".childrenCount").empty();
			$(".planVsActual").empty();
			$(".totalAttendance").empty();
			$("#centerCountId").empty();
			$("#centerCountId").append(data['center_count']);
			$(".teacherCount").append(data['teacher_count']);
			$(".active_teacherCount").append(data['active_teacher_count']);
			$(".active_offering_Count").append(data['active_offering_count']);
			$(".childrenCount").append(data['total_student']);
			$(".planVsActual").append(data['planvsact']+' %');
			$(".totalAttendance").append(data['child_attend']+' %');
		}
	});
}

$(document).ready(function(){
	if ($("#noCenter").val()!=''){
		 $(".messageBox").text($("#noCenter").val());
         $('.no_Center').removeClass('hide');
	}else{
	google.charts.load('current', {packages:['table', 'controls',"corechart",'bar',"LineChart"], callback: drawTable});
	function drawTable() {
		// from_time = $("#fromtime").val(); 
		// totime =  $("#totime").val(); 
		// console.log("sss",{{time_start}},{{time_end}})
		var params = 'center_id='+ '{{center_id}}' +'&ay_id='+ '{{ay_id}}'+'&funding_partner_id=' + '{{funding_partnerid}}' +  '&partner_id='+ '{{partner_id}}' + '&state=' + $("#state_id").val() + '&date_start=' + $("#from").val() + '&date_end=' + $("#to").val()+ '&time_start=' + '{{time_start}}' + '&time_end=' + '{{time_end}}';
		console.log("papapap",params)
		var funding_partner_id = {{funding_partnerid}}
		fetchCentersByState(funding_partner_id);
		getDashboardSummeryData(params);

		var piedata = new google.visualization.DataTable() ;
		piedata.addColumn('string','Status') ;
	    piedata.addColumn('number','Count') ;
	    $.ajax({
	    	url : '/v2/ajax/getStatsClassesData?' + params + '&type=classes',
	     	dataType : 'json',
	     	success : function(jsonData){
	     		var totalSessions = 0;
	     		if (jsonData!=null && jsonData!='' && jsonData!='undefined'){
	     			for(i=0;i<jsonData.length;i++) {
	     				piedata.addRow([jsonData[i]['status'], jsonData[i]['session_status_count']]);
	     				totalSessions += jsonData[i]['session_status_count'];
	     			}
	     		}
			 	var options = { title: 'Total Sessions ' + totalSessions, is3D: true, chartArea : {left : 10, width : '100%' }, legend: {position : 'right'},colors: ['red', 'green', 'orange', 'blue']} ;
			    var pie_div = new google.visualization.PieChart(document.getElementById('pie_div'));
			    pie_div.draw(piedata,options);
	     	 }
	     });

	    var reasonsPie = new google.visualization.DataTable() ;
        reasonsPie.addColumn('string','CancelReason') ;
        reasonsPie.addColumn('number','Count') ;
        $.ajax({
	    	url : '/v2/ajax/getStatsClassesData?' + params + '&type=cancell_reasons',
	     	dataType : 'json',
	     	success : function(jsonData){
	     		var totalCancellations = 0;
	     		if (jsonData!=null && jsonData!='' && jsonData!='undefined'){
	     			for(i=0;i<jsonData.length;i++) {
	     				if (jsonData[i]['cancel_reason']!=null && jsonData[i]['cancel_reason']!='' && jsonData[i]['cancel_reason']!='undefined'){
	     					reasonsPie.addRow([jsonData[i]['cancel_reason'], jsonData[i]['session_cancellReason_count']]);
	     					totalCancellations += jsonData[i]['session_cancellReason_count'];
	     				}
	     			}
	     		}
				 console.log("ddd",totalCancellations)
	     		var options = { title: 'Cancelled Sessions ' + totalCancellations, is3D: true, chartArea : {left : 10, width : '100%' }, legend: {position : 'right'}} ;
	     		var reasons_pie_div = new google.visualization.PieChart(document.getElementById('reasons_pie_div'));
	            reasons_pie_div.draw(reasonsPie, options);
	     	 }
	     });

        var data = new google.visualization.DataTable();
        var data1 = new google.visualization.DataTable();
        if ('{{center_id}}'=='-1'){
        	data.addColumn('string','Center') ;
            data.addColumn('number','Offerings') ;
            data.addColumn('number','Planned Sessions') ;
            data.addColumn('number','Actual Sessions') ;
			data.addColumn('number','Cancelled Sessions ') ;
			data.addColumn('number','Offline Sessions ') ;
            data.addColumn('number','Total Children') ;
            data.addColumn('number','Attendance Percentage') ;
			data.addColumn('number','No of students Attended') ;
        }else{
        	data.addColumn('string','Subject') ;
            data.addColumn('string','Grade') ;
            data.addColumn('string','Teacher') ;
            data.addColumn('number','Planned Sessions') ;
            data.addColumn('number','Actual Sessions') ;
			data.addColumn('number','Cancelled Sessions ') ;
			data.addColumn('number','Offline Sessions ') ;
            data.addColumn('number','Total Children') ;
            data.addColumn('number','Attendance Percentage') ;
			data.addColumn('number','No of students Attended') ;
            data1.addColumn('string', 'Name');
            data1.addColumn('number', 'Percentage');
            data1.addColumn({type: 'number', role: 'annotation'});
        }
        $.ajax({
	    	url : '/v2/ajax/getCenterOfferingDetails?' + params,
	     	dataType : 'json',
	     	success : function(jsonData){
	     		var totalCancellations = 0;
	     		if (jsonData!=null && jsonData!='' && jsonData!='undefined'){
	     			var totalp = 0;
	     			var count =0;
	     			jsonObj = {}
	     			var count =0;
	     			for(i=0; i<jsonData.length; i++){
	     				if ('{{center_id}}'=='-1'){
	     					count += jsonData[i]['total_children'];
	     					data.addRow([ jsonData[i]['center_name'], jsonData[i]['offering_count'], jsonData[i]['planned_session'],jsonData[i]['actual_session'],jsonData[i]['cancelled_session'],jsonData[i]['offline_session'],jsonData[i]['total_children'],jsonData[i]['attendance_perc'],jsonData[i]['students_present']]);
	     				}else{
							data.addRow([jsonData[i]['subject'],jsonData[i]['grade'],jsonData[i]['teacher'],jsonData[i]['planned_sessions'],jsonData[i]['actual_sessions'],jsonData[i]['cancelled_sessions'],jsonData[i]['offline_session'],jsonData[i]['total_children'],jsonData[i]['attendance_perc'],jsonData[i]['students_present']])
							if(jsonData[i]['total_attendance']>0){
								var grade_subject = jsonData[i]['grade'] + ' ' + jsonData[i]['subject'];
								data1.addRow([grade_subject ,jsonData[i]['attendance_perc'] ,jsonData[i]['attendance_perc']]);
								totalp += jsonData[i]['attendance_perc'];
								count += 1;
							}
	     				}
	     			}
	     			if ('{{center_id}}'!='-1'){
	     				data1.addRow([' Overall', Math.round(totalp/count),Math.round(totalp/count)])

	     			}
	     		}
	     		var summary_table = new google.visualization.Table(document.getElementById('table_div'));
	     	    summary_table.draw(data, {showRowNumber : true, page: 'enable',allowHtml: true,width:'100%', pageSize:10, pagingSymbols: {prev:'prev', next:'next'}});

	     	    var view = new google.visualization.DataView(data1);
	           	view.setColumns([0, 1, 1, 2]);
     	        var chart = new google.visualization.ComboChart(document.getElementById('my_div'));
     	        chart.draw(view, {
     	        	series: {
     	            	0: {
     	        			type: 'bars'
     	               	},
     	                1: {
     	                	type: 'line',
     	                   	color: 'Green',
     	                	lineWidth: 0,
     	                 	pointSize: 0,
     	                 	visibleInLegend: false
     	           		}
					},
     	            vAxis: {
     	            	maxValue: 100
     	            }
     	        });
	     	}
	     });



/*         Course details  */
		var grdata = new google.visualization.DataTable();
		grdata.addColumn('number','Months');
        grdata.addColumn('number','Expected');
        $.ajax({
	    	url : '/v2/ajax/getCourseCoverage?' + params,
	     	dataType : 'json',
	     	success : function(jsonData){
	     		if (jsonData!=null && jsonData!='' && jsonData!='undefined'){
	     			var course_table = jsonData[0]['course_table'];
	     			var course_table_tr = jsonData[0]['course_table_tr'];
	     			for(i=0;i<course_table.length;i++) {
	     				grdata.addColumn('number', course_table[i]['course']);
	     			}
	     			grdata.addRows(JSON.parse(course_table_tr));
	     			var options = {hAxis: {
	     			          title: 'Months (June to April)',
	     			          gridlines: {count: 11}
	     			        },
	     			        vAxis: {
	     			          title: 'No.of sessions',
	     			          maxValue : 40
	     			        },
	     			 };
    			    var chartgr = new google.visualization.LineChart(document.getElementById('gr_div'));
	     			chartgr.draw(grdata, options);
	     		}
	     	 }
	     });

/*         Classes Details */

 		var statusFilter1 = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'sess_status_div',
                'options':
                {
                    'filterColumnLabel' :   'Class Status',
                    'matchType'         :   'any'
                }
            }
        );

 		var centerFilter = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'center_div',
                'options':
                {
                    'filterColumnLabel' :   'Center',
                    'matchType'         :   'any'
                }
            }
        );


 		var cancelFilter1 = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'cancel_reason_id',
                'options':
                {
                    'filterColumnLabel' :   'Cancelled Reason',
                    'matchType'         :   'any'
                }
            }
        );

 		var teacherFilter = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'teacher_div',
                'options':
                {
                    'filterColumnLabel' :   'Teacher',
                    'matchType'         :   'any'
                }
            }
        );

 		var courseFilter1 = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'sess_coursefilter_div',
                'options':
                {
                    'filterColumnLabel' :   'Course',
                    'matchType'         :   'any'
                }
            }
        );

 		var sschartoptions =
        {
            'showRowNumber' : true,
            'page': 'enable',
            'pageSize':30,
            'pagingSymbols': {prev:'prev', next:'next'},
            'alternatingRowStyle'           :   true,
            'sort'                          :   'enable',
            'sortAscending'                 :   true,
            'allowHtml'                     :   true,
            'width'                         :   '100%'
        };

        var chartWrapper1 = new google.visualization.ChartWrapper
        (
            {
                'chartType'     :   'Table',
                'containerId'   :   'sess_table_div',
                'options'       :   sschartoptions,
                view: {
                    columns: [0,1,2,3,4,5,6,7,8]
                }
            }
        );
        var statusFilter = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'Session_status_div',
                'options':
                {
                    'filterColumnLabel' :   'Student',
                    'matchType'         :   'any'
                }
            }
        );

        var courseFilter = new google.visualization.ControlWrapper
        (
            {
                'controlType'           :   'CategoryFilter',
                'containerId'           :   'coursefilter_div',
                'options':
                {
                    'filterColumnLabel' :   'Course',
                    'matchType'         :   'any'
                }
            }
        );

        var tableChartOptions =
        {
            'showRowNumber' : true,
            'page': 'enable',
            'pageSize':30,
            'pagingSymbols': {prev:'prev', next:'next'},
            'alternatingRowStyle'           :   true,
            'sort'                          :   'enable',
            'sortAscending'                 :   true,
            'sortColumn'                    :   0,
            'allowHtml'                     :   true,
            'width'                         :   '100%'
        };

        var chartWrapper = new google.visualization.ChartWrapper
        (
            {
                'chartType'     :   'Table',
                'containerId'   :   'attnd_table_div',
                'options'       :   tableChartOptions,
                view: {
                    columns: [0,1,2,3,4,5,6,7]
                }
            }
        );

        var ssdata = new google.visualization.DataTable();
        ssdata.addColumn('string','Course');
        ssdata.addColumn('string','Class start');
        ssdata.addColumn('string','Class end');
        ssdata.addColumn('string','Teacher');
        ssdata.addColumn('string','Center');
        ssdata.addColumn('string','Class Status');
        ssdata.addColumn('string','Attendance Percent');
        ssdata.addColumn('string','Cancelled Reason');
		ssdata.addColumn('string','No of Students Attended');

        var aadata = new google.visualization.DataTable();
        aadata.addColumn('string','Student');
        aadata.addColumn('string','Course');
        aadata.addColumn('number','Total Sessions');
        aadata.addColumn('number','Classes Happened');
        aadata.addColumn('number','Present');
        aadata.addColumn('number','Absent');
        aadata.addColumn('number','Uncaptured');

        $.ajax({
        	url : '/v2/ajax/getAttndClassesData?'+ params,
        	dataType : 'JSON',
        	success : function(jsonData){
        		if (jsonData!=null && jsonData!='' && jsonData!='undefined'){
        			var sessionTable = jsonData['session_table'];
        			if (sessionTable!='undefined' && sessionTable!=null && sessionTable.length>0){
        				for (i=0;i<sessionTable.length;i++){
							// console.log("hhhhh",sessionTable[i]['total_student'])
        					ssdata.addRow([sessionTable[i]['course'], sessionTable[i]['starttime'],sessionTable[i]['endtime'],sessionTable[i]['Teacher'],sessionTable[i]['center'],sessionTable[i]['status'],sessionTable[i]['session_attendance'],sessionTable[i]['cancel_reason'],sessionTable[i]['total_student']]);
        				}
        			}
        			if ('{{center_id}}'!='-1'){
        				var attndTable = jsonData['attnd_table'];
            			if (attndTable!='undefined' && attndTable!=null && attndTable.length>0){
            				for (i=0;i<attndTable.length;i++){
            		            aadata.addRow([attndTable[i]['student'],attndTable[i]['course'],attndTable[i]['totalsess'],attndTable[i]['asoftoday'],attndTable[i]['present'],attndTable[i]['absent'],attndTable[i]['uncap']]);
            				}
            			}
        			}

        		}
        		if ('{{center_id}}'!='-1'){
        			var dashboard = new google.visualization.Dashboard(
        	            document.getElementById('attnd_dash_div')
        	        ).bind([statusFilter,courseFilter],chartWrapper).draw(aadata);
        		}
        		var dashboard = new google.visualization.Dashboard (
                    document.getElementById('sess_dash_div')
                ).bind([statusFilter1,courseFilter1,teacherFilter,centerFilter,cancelFilter1],chartWrapper1).draw(ssdata);
        	}

        });


	}
	}
});
$('body').on("click",".redirectTomyevidyaloka",function(){
	 window.location = "/myevidyaloka/";
});
</script>
{% endblock %} 
